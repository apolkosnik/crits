FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    build-essential \
    git \
    libldap2-dev \
    libsasl2-dev \
    libssl-dev \
    libfuzzy-dev \
    ssdeep \
    libmagic1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /crits

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip3 install -r requirements.txt

# Install testing dependencies
RUN pip3 install \
    pytest \
    pytest-django \
    pytest-cov \
    coverage \
    factory-boy \
    mock

# Copy application code
COPY . .

# Set environment variables for testing
ENV DJANGO_SETTINGS_MODULE=test_settings
ENV PYTHONPATH=/crits
ENV MONGO_HOST=mongodb-test
ENV MONGO_DATABASE=crits_test

# Create test directories
RUN mkdir -p /tmp/crits_test_media /tmp/crits_test_static logs

# Set permissions
RUN chmod +x manage.py

# Default command runs tests
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "--cov=crits", "--cov-report=html", "--cov-report=term"]